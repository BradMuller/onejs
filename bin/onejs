#!/usr/bin/env node

var one = require('../lib/one'),
    puts = require('sys').puts,
    buildOptions = {},
    REV;

var opt = require('optimist'),
    argv = opt
    .usage('Usage: $0 [OPTIONS]... [MANIFEST]')
    .options('t',{
      'alias':'target',
      'describe':'Target file to save the output'
    })
    .options('node',{
      'describe':'Include available node modules such as process, path. assert...'
    })
    .options('quiet',{
      'describe':'Make console output less verbose'
    })
    .options('verbose',{
      'describe':'Tell what\'s going on by being verbose.'
    })
    .options('version',{
      'describe':'Show version and exit'
    })
    .options('help',{
      'describe':'Show help.'
    })
    .argv;

REV = '1.1.0';

function run(options, target){
  one.build(options, function(error, sc){
    if(error) throw error;
    one.save(target, sc, function(error){
      if(error) throw error;
      process.exit(0);
    });
  });
}

function help(){
  opt.showHelp();
  process.exit(0);
}

function version(){
  puts('OneJS v' + REV);
  process.exit(0);
}


if(argv.t){
  one.verbose(false);
  argv.quiet && one.quiet(true);
  argv.verbose && one.verbose(true);

  buildOptions.node = argv.node;
  buildOptions.manifestPath = argv._[0] || 'package.json';

  run(buildOptions, argv.t);

} else if(argv.version){
  version();
} else {
  help();
}

