#!/usr/bin/env node

var one = require('../lib/one'),
    puts = require('sys').puts,
    buildOptions = {};

var REV = '1.1.0';

var opt = require('optimist'),
    argv = opt
    .usage('Usage: $0 [OPTIONS]... [MANIFEST]')
    .options('quiet',{
      'describe':'Make console output less verbose'
    })
    .options('verbose',{
      'describe':'Tell what\'s going on by being verbose.'
    })
    .options('version',{
      'describe':'Show version and exit'
    })
    .options('help',{
      'describe':'Show help.'
    })
    .argv;

function build(){
  var manifest = argv._[1],
      target = argv._[2];

  one.build({ 'manifestPath':manifest || 'package.json' }, function(error, pkg){
    if(error) throw error;
    if(target){
      one.save(target, pkg, function(error){
        if(error) throw error;
        process.exit(0);
      });
    } else {
      puts(pkg);
    }
  });
}

function help(){
  opt.showHelp(puts);
  process.exit(0);
}

function verbosity(){
  one.verbose(false);
  argv.quiet && one.quiet(true);
  argv.verbose && one.verbose(true);
}

function version(){
  puts('OneJS v' + REV);
  process.exit(0);
}

var action = argv._[0];

switch(action){
  case 'build': build(); break;
  case 'publish': publish(); break;
  case: 'require': require(); break;
  default:
    if(argv.version){
      version();
    } else {
      help();
    }
}

